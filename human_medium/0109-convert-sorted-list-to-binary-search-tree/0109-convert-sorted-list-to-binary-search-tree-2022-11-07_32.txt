class Solution:
    def sortedListToBST(self, head: Optional[ListNode]) -> Optional[TreeNode]:

        if not head:
            return head

        def find_mid(head, end=None):
            prev_slow = slow = fast = head
            while fast != end and fast.next != end:
                prev_slow = slow
                slow = slow.next
                fast = fast.next.next
            return slow, prev_slow


        def f(start, end=None):

            if start == end:
                return TreeNode(start.val)

            mid, prev_mid = find_mid(start, end)

            if start == mid:
                return TreeNode(mid.val, right=TreeNode(end.val))

            res = TreeNode(mid.val)

            res.left = f(start, prev_mid)
            res.right = f(mid.next, end)

            return res


        last = head
        while last.next != None:
            last = last.next

        res = f(head, last)

        return res
