class Solution:
    def sortList(self, head: Optional[ListNode]) -> Optional[ListNode]:
        dummy = ListNode(0, head)
        length = 0
        cur = head
        while cur:
            length += 1
            cur = cur.next
        
        def merge(start, end):
            pre = dummy
            left = start
            right = end
            while left and right:
                if left.val <= right.val:
                    pre.next = left
                    left = left.next
                else:
                    pre.next = right
                    right = right.next
                pre = pre.next
            if left:
                pre.next = left
            elif right:
                pre.next = right
        
        step = 1
        while step < length:
            start = dummy.next
            end = dummy
            while start:
                end = start
                pre = start
                for i in range(step):
                    pre = pre.next
                    end = end.next
                    if not end:
                        break
                merge(start, end)
                start = end.next
            step *= 2
        return dummy.next
