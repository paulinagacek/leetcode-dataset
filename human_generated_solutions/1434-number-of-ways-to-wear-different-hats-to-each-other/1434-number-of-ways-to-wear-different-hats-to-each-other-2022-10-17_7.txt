class Solution:
    def numberWays(self, hats: List[List[int]]) -> int:
        mod = 1000000007
        
        
        #people[i] -> people that prefers hat i
        people = [[] for _ in range(41)]
        for i in range(len(hats)):
            for hat in hats[i]:
                people[hat].append(i)             
        people = list(filter(None, people)) 
       
        #number of people
        npeople = len(hats)
        
        @cache
        def dp(mask=0, idx=len(people)-1):
            if mask.bit_count() == npeople: #if everyone has a hat then it is a valid combination
                return 1
            
            if idx < 0: #if hats out of range
                return 0
            
            res = dp(mask, idx-1) #skip the current hat
            for person in people[idx]:
                if mask&(1<<person) == 0:
                    res += dp(mask|(1<<person), idx-1) #use the current hat
                    
            return res%mod 
        
        return dp()